{"version":3,"sources":["../../../src/shell/drivers/DragDropDriver.ts"],"sourcesContent":["import { DragStartEvent, DragStopEvent } from \"shell/events/mouse\"\r\nimport { IDesignerShell, IDriver, IDriverFactory } from \"../../interfaces\"\r\n\r\nexport class DragDropDriverImpl implements IDriver {\r\n  private onMouseDownAt = 0\r\n  private startEvent: MouseEvent | null = null\r\n\r\n  constructor(private shell: IDesignerShell, private htmlElement: Element | Node | HTMLElement) {\r\n    this.attachEvent(\"mousedown\", this.onMouseDown)\r\n    this.attachEvent('dragend', this.onMouseUp)\r\n    this.attachEvent('dragstart', this.onStartDrag)\r\n    this.documentEl()?.addEventListener('mouseup', this.onMouseUp as EventListener)\r\n  }\r\n\r\n  onMouseDown = (e: MouseEvent) => {\r\n    if (e.button !== 0 || e.ctrlKey || e.metaKey) {\r\n      return\r\n    }\r\n    if (\r\n      (e.target as any)['isContentEditable'] ||\r\n      (e.target as any)['contentEditable'] === 'true'\r\n    ) {\r\n      return true\r\n    }\r\n    if ((e.target as any)?.['closest']?.('.monaco-editor')) return\r\n    this.startEvent = e\r\n    this.shell.dragging = false\r\n    this.onMouseDownAt = Date.now()\r\n    this.attachEvent('mousemove', this.onDistanceChange)\r\n  }\r\n\r\n  onMouseUp = (e: MouseEvent) => {\r\n    if (this.shell.dragging) {\r\n      this.shell.dispatch(\r\n        new DragStopEvent({\r\n          offsetX: e.offsetX,\r\n          offsetY: e.offsetY,\r\n          clientX: e.clientX,\r\n          clientY: e.clientY,\r\n          pageX: e.pageX,\r\n          pageY: e.pageY,\r\n          target: e.target,\r\n          view: e.view,\r\n          altKey: e.altKey,\r\n          ctrlKey: e.ctrlKey,\r\n          shiftKey: e.shiftKey,\r\n        }, e)\r\n      )\r\n    }\r\n    this.detachEvent('mousemove', this.onDistanceChange)\r\n    this.shell.dragging = false\r\n  }\r\n\r\n  onContextMenuWhileDragging = (e: MouseEvent) => {\r\n    e.preventDefault()\r\n  }\r\n\r\n  onStartDrag = (e: MouseEvent | DragEvent) => {\r\n    if (this.shell.dragging) return\r\n\r\n    this.startEvent = this.startEvent || e\r\n\r\n    this.attachEvent(\r\n      'contextmenu',\r\n      this.onContextMenuWhileDragging,\r\n    )\r\n\r\n    this.shell.dispatch(\r\n      new DragStartEvent({\r\n        offsetX: e.offsetX,\r\n        offsetY: e.offsetY,\r\n        clientX: this.startEvent.clientX,\r\n        clientY: this.startEvent.clientY,\r\n        pageX: this.startEvent.pageX,\r\n        pageY: this.startEvent.pageY,\r\n        target: (this.startEvent as any).path?.[0] || this.startEvent.target,\r\n        view: this.startEvent.view,\r\n        altKey: this.startEvent.altKey,\r\n        ctrlKey: this.startEvent.ctrlKey,\r\n        shiftKey: this.startEvent.shiftKey,\r\n      }, e)\r\n    )\r\n    this.shell.dragging = true\r\n  }\r\n\r\n  onDistanceChange = (e: MouseEvent) => {\r\n    if (!this.startEvent) {\r\n      return\r\n    }\r\n\r\n    const distance = Math.sqrt(\r\n      Math.pow(e.pageX - this.startEvent.pageX, 2) +\r\n      Math.pow(e.pageY - this.startEvent.pageY, 2)\r\n    )\r\n    const timeDelta = Date.now() - this.onMouseDownAt\r\n    if (timeDelta > 10 && e !== this.startEvent && distance > 4) {\r\n      this.detachEvent('mousemove', this.onDistanceChange)\r\n      this.onStartDrag(e)\r\n    }\r\n  }\r\n\r\n  private attachEvent<K extends keyof HTMLElementEventMap>(\r\n    type: K,\r\n    listener: (this: HTMLElement, ev: HTMLElementEventMap[K]) => any,\r\n  ): void\r\n  private attachEvent(\r\n    type: string,\r\n    listener: EventListenerOrEventListenerObject,\r\n  ): void\r\n  private attachEvent(type: any, listener: any) {\r\n    this.htmlElement?.addEventListener(type, listener as any)\r\n  }\r\n\r\n  private detachEvent<K extends keyof HTMLElementEventMap>(\r\n    type: K,\r\n    listener: (this: HTMLElement, ev: HTMLElementEventMap[K]) => any,\r\n  ): void\r\n  private detachEvent(\r\n    type: string,\r\n    listener: EventListenerOrEventListenerObject,\r\n  ): void\r\n  private detachEvent(type: any, listener: any) {\r\n    this.htmlElement?.removeEventListener(type, listener)\r\n  }\r\n\r\n  teardown(): void {\r\n    this.detachEvent('mousedown', this.onMouseDown)\r\n    this.detachEvent('dragstart', this.onStartDrag)\r\n    this.detachEvent('dragend', this.onMouseUp)\r\n    this.documentEl()?.removeEventListener('mouseup', this.onMouseUp as EventListener)\r\n    this.detachEvent('mousemove', this.onDistanceChange)\r\n    this.detachEvent(\r\n      'contextmenu',\r\n      this.onContextMenuWhileDragging,\r\n    )\r\n  }\r\n\r\n  private documentEl(){\r\n    return this.htmlElement?.ownerDocument || this.htmlElement\r\n  }\r\n}\r\n\r\nexport const DragDropDriver: IDriverFactory = (\r\n  shell: IDesignerShell,\r\n  htmlElement: Element | Node | HTMLElement,\r\n) => {\r\n  return new DragDropDriverImpl(\r\n    shell,\r\n    htmlElement,\r\n  )\r\n}"],"names":["DragStartEvent","DragStopEvent","DragDropDriverImpl","attachEvent","type","listener","htmlElement","addEventListener","detachEvent","removeEventListener","teardown","onMouseDown","onStartDrag","onMouseUp","documentEl","onDistanceChange","onContextMenuWhileDragging","ownerDocument","constructor","shell","onMouseDownAt","startEvent","e","button","ctrlKey","metaKey","target","dragging","Date","now","dispatch","offsetX","offsetY","clientX","clientY","pageX","pageY","view","altKey","shiftKey","preventDefault","path","distance","Math","sqrt","pow","timeDelta","DragDropDriver"],"mappings":"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"}