{"version":3,"sources":["../../src/classes/DesignerEngine.ts"],"sourcesContent":["import { State } from \"reducers\";\r\nimport { IDesignerEngine, IDesignerShell, IMonitor, INodeSchema, IDocument, IResourceManager, ID, IComponentManager, NodeBehavior, AbleCheckFunction } from \"interfaces\";\r\nimport { Store } from \"redux\";\r\nimport { ResourceManager } from \"./ResourceManager\";\r\nimport { DocumentImpl } from \"classes/DocumentImpl\";\r\nimport { invariant } from \"utils/util-invariant\";\r\nimport { IActions, IAction } from \"interfaces/action\";\r\nimport { Actions } from \"actions\";\r\nimport { ILocalesManager } from \"interfaces/loacales\";\r\nimport { LocalesManager } from \"./LocalesManager\";\r\nimport { CHANGE_ACTIVED_DOCUMENT, SET_LANGUAGE } from \"actions/registry\";\r\nimport { DefualtLang } from \"reducers/lang\";\r\nimport { ComponentManager } from \"./ComponentManager\";\r\nimport { IPlugin, IPluginFactory } from \"interfaces/plugin\";\r\nimport { isFn } from \"utils/types\";\r\nimport { IDecoratorManager } from \"interfaces/decorator\";\r\nimport { DecoratorManager } from \"./DecoratorManager\";\r\n\r\nexport class DesignerEngine implements IDesignerEngine {\r\n\tprivate documentsById: {\r\n\t\t[id: ID]: IDocument\r\n\t} = {}\r\n\tprivate resourceManager: IResourceManager\r\n\tprivate localesManager: ILocalesManager\r\n\tprivate actions: IActions\r\n\tprivate componentManager: IComponentManager\r\n\tprivate decoratorManager: IDecoratorManager\r\n\tprivate plugins: {\r\n\t\t[name: string]: IPlugin | undefined\r\n\t} = {}\r\n\tpublic constructor(private store: Store<State>,\r\n\t\tprivate shell: IDesignerShell,\r\n\t\tprivate monitor: IMonitor,\r\n\t\tplugins: IPluginFactory[],\r\n\t\tlang?: string\r\n\t) {\r\n\t\tthis.localesManager = new LocalesManager(lang || DefualtLang)\r\n\t\tthis.resourceManager = new ResourceManager(this.localesManager)\r\n\t\tthis.decoratorManager = new DecoratorManager(this)\r\n\t\tthis.actions = new Actions(this)\r\n\t\tthis.componentManager = new ComponentManager(this)\r\n\t\tfor (const pluginFactory of plugins) {\r\n\t\t\tthis.registerPlugin(pluginFactory)\r\n\t\t}\r\n\t}\r\n\tgetDecoratorManager(): IDecoratorManager {\r\n\t\treturn this.decoratorManager\r\n\t}\r\n\r\n\tgetComponentManager(): IComponentManager {\r\n\t\treturn this.componentManager\r\n\t}\r\n\tgetLoacalesManager(): ILocalesManager {\r\n\t\treturn this.localesManager\r\n\t}\r\n\tgetLanguage(): string {\r\n\t\treturn this.getMonitor().getState().lang\r\n\t}\r\n\tsetLanguage(lang: string): void {\r\n\t\tthis.getLoacalesManager().setLanguage(lang)\r\n\t\tthis.dispatch({\r\n\t\t\ttype: SET_LANGUAGE,\r\n\t\t\tpayload: lang\r\n\t\t})\r\n\t}\r\n\r\n\tgetNodeDocument(nodeId: string): IDocument | null {\r\n\t\tconst documentId = this.monitor.getNodeDocumentId(nodeId)\r\n\t\tinvariant(documentId, \"can not find node document id\")\r\n\t\treturn documentId ? this.getDocument(documentId) : null\r\n\t}\r\n\r\n\tgetAllDocuments(): IDocument[] | null {\r\n\t\tconst docs = []\r\n\t\tfor (const key of Object.keys(this.documentsById)) {\r\n\t\t\tdocs.push(this.documentsById[key])\r\n\t\t}\r\n\t\treturn docs\r\n\t}\r\n\r\n\tsetSelectionMode(mode: SelectionMode): void {\r\n\t\tthrow new Error(\"Method not implemented.\");\r\n\t}\r\n\tcreateDocument(schema: INodeSchema): IDocument {\r\n\t\tconst doc = new DocumentImpl(schema, this, this.store)\r\n\t\tthis.documentsById[doc.id] = doc\r\n\t\tthis.dispatch({\r\n\t\t\ttype: CHANGE_ACTIVED_DOCUMENT,\r\n\t\t\tpayload: doc.id\r\n\t\t})\r\n\t\treturn doc\r\n\t}\r\n\tgetDocument(id: string): IDocument | null {\r\n\t\treturn this.documentsById[id]\r\n\t}\r\n\r\n\tgetResourceManager(): IResourceManager {\r\n\t\treturn this.resourceManager\r\n\t}\r\n\r\n\tpublic getMonitor(): IMonitor {\r\n\t\treturn this.monitor\r\n\t}\r\n\r\n\tpublic getShell(): IDesignerShell {\r\n\t\treturn this.shell\r\n\t}\r\n\r\n\tpublic getActions(): IActions {\r\n\t\treturn this.actions\r\n\t}\r\n\r\n\tpublic dispatch(action: IAction<any>): void {\r\n\t\tthis.store.dispatch(action)\r\n\t}\r\n\r\n\tpublic destory(): void {\r\n\t\tfor (const key of Object.keys(this.plugins)) {\r\n\t\t\tthis.plugins[key]?.destory()\r\n\t\t}\r\n\t\tthis.shell.destory()\r\n\t}\r\n\r\n\tgetNodeBehavior(nodeId: ID): NodeBehavior {\r\n\t\treturn {\r\n\t\t\tisDisabled: () => checkAbility(\"disabled\", false, nodeId, this),\r\n\t\t\tisSelectable: () => checkAbility(\"selectable\", true, nodeId, this),\r\n\t\t\tisDroppable: () => checkAbility(\"droppable\", false, nodeId, this),\r\n\t\t\tisDraggable: () => checkAbility(\"draggable\", true, nodeId, this),\r\n\t\t\tisDeletable: () => checkAbility(\"deletable\", true, nodeId, this),\r\n\t\t\tisCloneable: () => checkAbility(\"cloneable\", true, nodeId, this),\r\n\t\t\tisNoPlaceholder: () => checkAbility(\"noPlaceholder\", false, nodeId, this),\r\n\t\t\tisNoRef: () => checkAbility(\"noRef\", false, nodeId, this),\r\n\t\t\tisLockable: () => checkAbility(\"lockable\", false, nodeId, this),\r\n\t\t}\r\n\t}\r\n\r\n\tregisterPlugin(pluginFactory: IPluginFactory): void {\r\n\t\tconst plugin = pluginFactory(this)\r\n\t\tthis.plugins[plugin.name] = plugin\r\n\t}\r\n\tgetPlugin(name: string): IPlugin | null {\r\n\t\treturn this.plugins[name] || null\r\n\t}\r\n}\r\n\r\nexport const checkAbility = (\r\n\tname: \"disabled\" | \"selectable\" | \"droppable\" | \"draggable\" | \"deletable\" | \"cloneable\" | \"noPlaceholder\" | \"noRef\" | \"lockable\",\r\n\tdefaultValue: boolean,\r\n\tnodeId: ID,\r\n\tengine: IDesignerEngine\r\n) => {\r\n\tconst nodeRules = engine.getComponentManager().getNodeBehaviorRules(nodeId)\r\n\tfor (const rule of nodeRules) {\r\n\t\tconst able = ableCheck(defaultValue, nodeId, rule[name], engine)\r\n\t\tif (able !== defaultValue) {\r\n\t\t\treturn able\r\n\t\t}\r\n\t}\r\n\r\n\treturn defaultValue\r\n}\r\n\r\n\r\nconst ableCheck = (defaultValue: boolean, nodeId: ID, able: boolean | AbleCheckFunction | undefined, engine: IDesignerEngine): boolean => {\r\n\tif (able === undefined) {\r\n\t\treturn defaultValue\r\n\t}\r\n\tif (isFn(able)) {\r\n\t\treturn able(nodeId, engine)\r\n\t}\r\n\treturn able || false\r\n}\r\n"],"names":["ResourceManager","DocumentImpl","invariant","Actions","LocalesManager","CHANGE_ACTIVED_DOCUMENT","SET_LANGUAGE","DefualtLang","ComponentManager","isFn","DecoratorManager","DesignerEngine","getDecoratorManager","decoratorManager","getComponentManager","componentManager","getLoacalesManager","localesManager","getLanguage","getMonitor","getState","lang","setLanguage","dispatch","type","payload","getNodeDocument","nodeId","documentId","monitor","getNodeDocumentId","getDocument","getAllDocuments","docs","key","Object","keys","documentsById","push","setSelectionMode","mode","Error","createDocument","schema","doc","store","id","getResourceManager","resourceManager","getShell","shell","getActions","actions","action","destory","plugins","getNodeBehavior","isDisabled","checkAbility","isSelectable","isDroppable","isDraggable","isDeletable","isCloneable","isNoPlaceholder","isNoRef","isLockable","registerPlugin","pluginFactory","plugin","name","getPlugin","defaultValue","engine","nodeRules","getNodeBehaviorRules","rule","able","ableCheck","undefined"],"mappings":"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"}