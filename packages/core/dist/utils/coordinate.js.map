{"version":3,"sources":["../../src/utils/coordinate.ts"],"sourcesContent":["import { IMouseEventData } from \"shell/events/mouse/AbstractMouseEvent\";\nimport { IDesignerEngine, IRect, ITreeNode } from \"interfaces\";\nimport { before } from \"./array-helper\";\nimport { calcElementLayout } from \"./element\";\n\nconst dropInMargin = 8\n\nexport enum RelativePosition {\n  In = \"in\",\n  Left = \"left\",\n  Top = \"top\",\n  Right = \"right\",\n  Bottom = \"bottom\",\n}\n\nexport interface IDropPosition {\n  position: RelativePosition | null;\n  targetId: string;\n}\n\nexport class Rect {\n  rect: IRect;\n\n  constructor(rect: IRect) {\n    this.rect = rect;\n  }\n\n  get left() {\n    return this.rect.x\n  }\n\n  get right() {\n    return this.rect.x + this.rect.width\n  }\n\n  get top() {\n    return this.rect.y\n  }\n\n  get bottom() {\n    return this.rect.y + this.rect.height\n  }\n\n  isIn(eventData?: IMouseEventData) {\n    if (!eventData) {\n      return false;\n    }\n    return (\n      this.left <= eventData.clientX &&\n      this.right >= eventData.clientX &&\n      this.top <= eventData.clientY &&\n      this.bottom >= eventData.clientY\n    );\n  }\n\n  isOnLeft(event?: IMouseEventData) {\n    if (!event) {\n      return false;\n    }\n\n    return this.left > event.clientX;\n  }\n\n  isOnRight(event?: IMouseEventData) {\n    if (!event) {\n      return false;\n    }\n\n    return this.right < event.clientX;\n  }\n\n  isOnTop(event?: IMouseEventData) {\n    if (!event) {\n      return false;\n    }\n\n    return this.top > event.clientY;\n  }\n\n  isOnBottom(event?: IMouseEventData) {\n    if (!event) {\n      return false;\n    }\n\n    return this.bottom < event.clientY;\n  }\n\n  atOutPosition(\n    event: IMouseEventData | undefined,\n    layout: \"vertical\" | \"horizontal\"\n  ): RelativePosition | null {\n    if (!event || !this.isIn(event)) {\n      return null;\n    }\n\n    let xRatio =\n      (event.clientX - this.rect.x) /\n      (this.rect.x + this.rect.width - event.clientX);\n    let yRatio =\n      (event.clientY - this.rect.y) /\n      (this.rect.y + this.rect.height - event.clientY);\n\n    if (layout === \"horizontal\") {\n      if (xRatio <= 1) {\n        return RelativePosition.Left\n      } else {\n        return RelativePosition.Right\n      }\n    } else {\n      if (yRatio <= 1) {\n        return RelativePosition.Top\n      } else {\n        return RelativePosition.Bottom\n      }\n    }\n  }\n}\n\nexport class PositionJudger {\n  constructor(private node: ITreeNode, private engine: IDesignerEngine) { }\n\n  get dropInMargin() {\n    let nodeName = this.node?.meta?.componentName;\n    if (!nodeName) {\n      return 0;\n    }\n    return this.node.parentId ? dropInMargin : 0;\n  }\n\n  //在此区域内，算是拖入\n  get dragInRect() {\n    const rect = this.engine.getShell().getElement(this.node.id)?.getBoundingClientRect();\n    if (!rect) {\n      return undefined;\n    }\n    return new Rect({\n      ...rect,\n      x: rect.x + this.dropInMargin,\n      width: rect.width - this.dropInMargin * 2,\n      y: rect.top + this.dropInMargin,\n      height: rect.height - this.dropInMargin * 2,\n    });\n  }\n\n  get rect() {\n    const rect = this.engine.getShell().getElement(this.node.id)?.getBoundingClientRect();\n    if (!rect) {\n      return undefined;\n    }\n    return new Rect(rect);\n  }\n\n\n  isDragIn(eventData: IMouseEventData) {\n    return this.dragInRect?.isIn(eventData);\n  }\n\n  firstChildAfterMouse(event: IMouseEventData, node?: ITreeNode) {\n    let theNode = node || this.node;\n    if (!theNode) {\n      return;\n    }\n    for (let childId of theNode.children) {\n      const child = this.engine.getMonitor().getNode(childId);\n      if (child && this.isAfterMouse(event, child)) {\n        return child;\n      }\n    }\n\n    return undefined;\n  }\n\n  isAfterMouse(event: IMouseEventData, node?: ITreeNode): boolean {\n    let theNode = node || this.node;\n    if (!theNode) {\n      return false;\n    }\n\n    const { clientX, clientY } = event;\n\n    let rect = this.engine.getShell().getElement(theNode.id)?.getBoundingClientRect();\n    if (!rect) {\n      return false;\n    }\n\n    if (rect.left >= clientX) {\n      return true;\n    }\n\n    if (rect.top >= clientY) {\n      return true;\n    }\n\n    return false;\n  }\n\n  judgePosition(\n    eventData: IMouseEventData\n  ): IDropPosition | null {\n    if (this.isDragIn(eventData)) {\n      //如果没有子节点\n      if (!this.node.children?.length) {\n        return {\n          targetId: this.node.id,\n          position: RelativePosition.In\n        }\n      }\n\n      //鼠标后第一个子节点\n      const afterChild = this.firstChildAfterMouse(eventData);\n\n      const parent = afterChild?.parentId ? this.engine.getMonitor().getNode(afterChild?.parentId) : undefined;\n      let beforeId = afterChild?.id\n        ? before(afterChild.id, parent?.children)\n        : this.node.children?.[this.node.children.length - 1];\n\n      let beforeChild = this.engine.getMonitor().getNode(beforeId);\n\n      if (beforeChild && beforeChild.id !== this.node.id) {\n        const element = this.engine.getShell().getElement(beforeChild.id)\n        if (element) {\n          const layout = calcElementLayout(element)\n          if (layout === \"horizontal\") {\n            return {\n              targetId: beforeChild.id,\n              position: RelativePosition.Right\n            }\n          } else {\n            return {\n              targetId: beforeChild.id,\n              position: RelativePosition.Bottom\n            }\n          }\n        } else {\n          //console.error(\"can not find node element\")\n        }\n      } else if (afterChild) {\n        const element = this.engine.getShell().getElement(afterChild.id)\n        if (element) {\n          const layout = calcElementLayout(element)\n          if (layout === \"horizontal\") {\n            return {\n              targetId: afterChild.id,\n              position: RelativePosition.Left\n            }\n          } else {\n            return {\n              targetId: afterChild.id,\n              position: RelativePosition.Top\n            }\n          }\n        } else {\n          //console.error(\"can not find node element\")\n        }\n      }\n      return null\n    } else {\n      if (!this.node.parentId) {\n        //console.log('undefined1')\n        return null;\n      }\n      const element = this.engine.getShell().getElement(this.node.id)\n      if (element) {\n        const layout = calcElementLayout(element)\n        return {\n          targetId: this.node.id,\n          position: this.rect?.atOutPosition(eventData, layout || \"vertical\") || null,\n        };\n      } else {\n        //console.error(\"can not find node element\")\n        return null\n      }\n\n    }\n  }\n}\n"],"names":["before","calcElementLayout","dropInMargin","RelativePosition","In","Left","Top","Right","Bottom","Rect","left","rect","x","right","width","top","y","bottom","height","isIn","eventData","clientX","clientY","isOnLeft","event","isOnRight","isOnTop","isOnBottom","atOutPosition","layout","xRatio","yRatio","constructor","PositionJudger","nodeName","node","meta","componentName","parentId","dragInRect","engine","getShell","getElement","id","getBoundingClientRect","undefined","isDragIn","firstChildAfterMouse","theNode","childId","children","child","getMonitor","getNode","isAfterMouse","judgePosition","length","targetId","position","afterChild","parent","beforeId","beforeChild","element"],"mappings":"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"}