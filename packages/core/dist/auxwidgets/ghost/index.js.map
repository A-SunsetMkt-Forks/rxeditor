{"version":3,"sources":["../../../src/auxwidgets/ghost/index.ts"],"sourcesContent":["import { IDesignerEngine, IDesignerShell, Unsubscribe } from \"core\";\r\nimport { DragStartEvent, MouseMoveEvent } from \"shell/events/mouse\";\r\nimport { IPlugin } from \"interfaces/plugin\";\r\nimport { DraggingNodesState } from \"reducers/draggingNodes\";\r\nimport { DraggingResourceState } from \"reducers/draggingResource\";\r\nimport { numbToPx } from \"../utils/numbToPx\";\r\n\r\nexport class GhostWidgetImpl implements IPlugin {\r\n  name: string = \"default.ghost\";\r\n  htmlNode: HTMLElement;\r\n  draggingNodesOff: Unsubscribe\r\n  draggingResourceOff: Unsubscribe\r\n  dragOff: Unsubscribe | null = null\r\n  dragStopOff: Unsubscribe | null = null\r\n  shell: IDesignerShell\r\n  startEvent: DragStartEvent | null = null\r\n  title: string = \"undefined\"\r\n  mounted: boolean = false\r\n\r\n  constructor(private engine: IDesignerEngine) {\r\n    const htmlNode = document.createElement('div')\r\n    htmlNode.style.backgroundColor = \"blue\"\r\n    htmlNode.style.position = \"fixed\"\r\n    htmlNode.style.display = \"none\"\r\n    htmlNode.style.color = '#fff'\r\n    htmlNode.style.fontSize = '13px'\r\n    htmlNode.style.padding = \"4px 8px\"\r\n    htmlNode.style.pointerEvents = \"none\"\r\n    htmlNode.style.whiteSpace = \"nowrap\"\r\n    htmlNode.style.zIndex = \"10000\"\r\n    this.htmlNode = htmlNode\r\n    this.shell = engine.getShell()\r\n    if (!engine.getShell().getContainer) {\r\n      console.error(\"Html 5 driver rootElement is undefined\")\r\n    }\r\n    this.draggingNodesOff = this.engine.getMonitor().subscribeToDraggingNodes(this.handleDraggingNodes)\r\n    this.draggingResourceOff = this.engine.getMonitor().subscribeToDraggingResource(this.handleDraggingResource)\r\n    this.dragOff = this.shell.subscribeTo(MouseMoveEvent, this.handleDrag)\r\n  }\r\n\r\n  handleDraggingNodes = (dragging: DraggingNodesState | null) => {\r\n    if (dragging) {\r\n      const node = this.engine.getMonitor().getNode(dragging.nodeIds[0])\r\n      if (node) {\r\n        this.title = node.title || node.meta.componentName\r\n        this.mounted = true\r\n      }\r\n    } else {\r\n      this.unmount()\r\n    }\r\n  }\r\n\r\n  handleDraggingResource = (dragging: DraggingResourceState | null) => {\r\n    if (dragging) {\r\n      const resource = this.engine.getResourceManager().getResource(dragging.resource)\r\n      if (resource) {\r\n        this.title = resource.title || resource.id || \"undefined\"\r\n        this.mount()\r\n      }\r\n    } else {\r\n      this.unmount()\r\n    }\r\n  }\r\n\r\n  handleDrag = (e: MouseMoveEvent): void => {\r\n    if (this.mounted && this.engine.getShell().dragging) {\r\n      const container = this.engine.getShell().getContainer()\r\n      if(container && !container.contains(this.htmlNode)){\r\n        if(this.htmlNode.parentElement){\r\n          this.htmlNode.remove()\r\n        }\r\n        container.appendChild(this.htmlNode)\r\n      }\r\n      this.htmlNode.style.display = \"block\"\r\n      this.htmlNode.innerHTML = this.title\r\n      this.htmlNode.style.left = numbToPx(e.data.topClientX)\r\n      this.htmlNode.style.top = numbToPx(e.data.topClientY)\r\n    }\r\n  }\r\n\r\n  destory(): void {\r\n    this.unmount()\r\n    this.dragOff?.()\r\n    this.draggingNodesOff?.()\r\n    this.draggingResourceOff?.()\r\n    this.dragStopOff?.()\r\n  }\r\n\r\n  private mount() {\r\n    if (this.htmlNode) {\r\n      this.mounted = true\r\n    }\r\n  }\r\n\r\n  private unmount() {\r\n    if (this.mounted && this.htmlNode) {\r\n      this.htmlNode.remove()\r\n      this.mounted = false\r\n    }\r\n  }\r\n}\r\n\r\nexport const GhostWidget = (engine: IDesignerEngine) => {\r\n  return new GhostWidgetImpl(engine)\r\n}"],"names":["MouseMoveEvent","numbToPx","GhostWidgetImpl","destory","unmount","dragOff","draggingNodesOff","draggingResourceOff","dragStopOff","mount","htmlNode","mounted","remove","constructor","engine","name","startEvent","title","handleDraggingNodes","dragging","node","getMonitor","getNode","nodeIds","meta","componentName","handleDraggingResource","resource","getResourceManager","getResource","id","handleDrag","e","getShell","container","getContainer","contains","parentElement","appendChild","style","display","innerHTML","left","data","topClientX","top","topClientY","document","createElement","backgroundColor","position","color","fontSize","padding","pointerEvents","whiteSpace","zIndex","shell","console","error","subscribeToDraggingNodes","subscribeToDraggingResource","subscribeTo","GhostWidget"],"mappings":"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"}