{"version":3,"sources":["../../../src/auxwidgets/insertion/index.ts"],"sourcesContent":["import { numbToPx } from \"auxwidgets/utils/numbToPx\";\r\nimport { IDesignerEngine, IDesignerShell, Unsubscribe } from \"core\";\r\nimport { AcceptType } from \"interfaces/action\";\r\nimport { IPlugin } from \"interfaces/plugin\";\r\nimport { DragOverState } from \"reducers/dragOver\";\r\nimport { addZIndex } from \"utils/add-zindex\";\r\nimport { RelativePosition } from \"utils/coordinate\";\r\n\r\nexport class InsertionCursorImpl implements IPlugin {\r\n  name: string = \"default.insertion\";\r\n  htmlCoverNode: HTMLElement;\r\n  htmlCursorNode: HTMLElement;\r\n  detachDragover: Unsubscribe\r\n  shell: IDesignerShell\r\n\r\n  constructor(private engine: IDesignerEngine) {\r\n    if (!engine.getShell().getContainer) {\r\n      console.error(\"Html 5 driver rootElement is undefined\")\r\n    }\r\n    this.shell = engine.getShell()\r\n\r\n    const htmlNode = document.createElement('div')\r\n    htmlNode.style.position = \"fixed\"\r\n    htmlNode.style.display = \"none\"\r\n    htmlNode.style.pointerEvents = \"none\"\r\n    htmlNode.style.opacity = \"0.1\"\r\n    this.htmlCoverNode = htmlNode\r\n\r\n    const htmlCursorNode = document.createElement('div')\r\n    htmlCursorNode.style.position = \"fixed\"\r\n    htmlCursorNode.style.display = \"none\"\r\n    htmlCursorNode.style.pointerEvents = \"none\"\r\n    this.htmlCursorNode = htmlCursorNode\r\n\r\n    this.detachDragover = this.engine.getMonitor().subscribeToDragOver(this.handleDragOver)\r\n  }\r\n\r\n  handleDragOver = (dragover: DragOverState) => {\r\n    if (dragover) {\r\n      if (dragover?.position === \"in\") {\r\n        if (!this.shell.getContainer()?.contains(this.htmlCoverNode)) {\r\n          this.shell.getContainer()?.appendChild(this.htmlCoverNode)\r\n        }\r\n        this.renderCover(dragover)\r\n        this.htmlCursorNode.style.display = \"none\"\r\n      } else {\r\n        if (!this.shell.getContainer()?.contains(this.htmlCursorNode)) {\r\n          this.shell.getContainer()?.appendChild(this.htmlCursorNode)\r\n        }\r\n        this.renderCusor(dragover)\r\n        this.htmlCoverNode.style.display = \"none\"\r\n      }\r\n    } else {\r\n      this.htmlCursorNode.style.display = \"none\"\r\n      this.htmlCoverNode.style.display = \"none\"\r\n    }\r\n  }\r\n\r\n  private renderCover = (dragover: DragOverState) => {\r\n    const rect = this.engine.getShell().getTopRect(dragover?.targetId || \"\")\r\n\r\n    if (rect) {\r\n      if (dragover?.type === AcceptType.Reject) {\r\n        this.htmlCoverNode.style.backgroundColor = \"red\"\r\n      } else {\r\n        this.htmlCoverNode.style.backgroundColor = \"blue\"\r\n      }\r\n\r\n      this.htmlCoverNode.style.display = \"block\"\r\n      this.htmlCursorNode.style.zIndex = addZIndex(window.getComputedStyle(this.htmlCursorNode).zIndex, 1)\r\n      this.htmlCoverNode.style.top = numbToPx(rect.y)\r\n      this.htmlCoverNode.style.left = numbToPx(rect.x)\r\n      this.htmlCoverNode.style.width = numbToPx(rect.width)\r\n      this.htmlCoverNode.style.height = numbToPx(rect.height)\r\n    }\r\n  }\r\n\r\n  private renderCusor = (dragover: DragOverState) => {\r\n    const htmlDiv = this.engine.getShell().getElement(dragover?.targetId || \"\")\r\n    const rect = this.engine.getShell().getTopRect(dragover?.targetId || \"\")\r\n    if (rect && htmlDiv && dragover) {\r\n      if (dragover.type === AcceptType.Accept) {\r\n        this.htmlCursorNode.style.backgroundColor = \"blue\"\r\n      } else {\r\n        this.htmlCursorNode.style.backgroundColor = \"red\"\r\n      }\r\n      this.htmlCursorNode.style.display = \"block\"\r\n      this.htmlCursorNode.style.zIndex = \"2\";//addZIndex(window.getComputedStyle(htmlDiv).zIndex, 2)\r\n      if (dragover.position === RelativePosition.Bottom) {\r\n        this.htmlCursorNode.style.top = numbToPx(rect.y + rect.height)\r\n        this.htmlCursorNode.style.left = numbToPx(rect.x)\r\n        this.htmlCursorNode.style.width = numbToPx(rect.width)\r\n        this.htmlCursorNode.style.height = \"2px\"\r\n      }\r\n      if (dragover.position === RelativePosition.Top) {\r\n        this.htmlCursorNode.style.top = numbToPx(rect.y)\r\n        this.htmlCursorNode.style.left = numbToPx(rect.x)\r\n        this.htmlCursorNode.style.width = numbToPx(rect.width)\r\n        this.htmlCursorNode.style.height = \"2px\"\r\n      }\r\n      if (dragover.position === RelativePosition.Left) {\r\n        this.htmlCursorNode.style.top = numbToPx(rect.y)\r\n        this.htmlCursorNode.style.left = numbToPx(rect.x)\r\n        this.htmlCursorNode.style.width = \"2px\"\r\n        this.htmlCursorNode.style.height = numbToPx(rect.height)\r\n      }\r\n      if (dragover.position === RelativePosition.Right) {\r\n        this.htmlCursorNode.style.top = numbToPx(rect.y)\r\n        this.htmlCursorNode.style.left = numbToPx(rect.x + rect.width)\r\n        this.htmlCursorNode.style.width = \"2px\"\r\n        this.htmlCursorNode.style.height = numbToPx(rect.height)\r\n      }\r\n    }\r\n  }\r\n\r\n  destory(): void {\r\n    this.detachDragover()\r\n    this.htmlCoverNode.remove()\r\n    this.htmlCursorNode.remove()\r\n  }\r\n\r\n}\r\n\r\nexport const InsertionCursor = (engine: IDesignerEngine) => {\r\n  return new InsertionCursorImpl(engine)\r\n}"],"names":["numbToPx","AcceptType","addZIndex","RelativePosition","InsertionCursorImpl","destory","detachDragover","htmlCoverNode","remove","htmlCursorNode","constructor","engine","name","handleDragOver","dragover","position","shell","getContainer","contains","appendChild","renderCover","style","display","renderCusor","rect","getShell","getTopRect","targetId","type","Reject","backgroundColor","zIndex","window","getComputedStyle","top","y","left","x","width","height","htmlDiv","getElement","Accept","Bottom","Top","Left","Right","console","error","htmlNode","document","createElement","pointerEvents","opacity","getMonitor","subscribeToDragOver","InsertionCursor"],"mappings":"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"}