{"version":3,"sources":["../../../src/auxwidgets/outlines/ActivedOutline.ts"],"sourcesContent":["import { CanvasScrollEvent } from \"../../shell/events\";\r\nimport { MouseOutEvent } from \"../../shell/events/mouse/MouseOutEvent\";\r\nimport { IPlugin } from \"../../interfaces/plugin\";\r\nimport { AUX_BACKGROUND_COLOR } from \"../consts\";\r\nimport { numbToPx } from \"../utils/numbToPx\";\r\nimport { getMaxZIndex } from \"./getMaxZIndex\";\r\nimport { ID, IDesignerEngine, Unsubscribe } from \"../../interfaces\";\r\n\r\nexport class ActivedOutlineImpl implements IPlugin {\r\n  name: string = \"default.actived-outline\";\r\n  resizeObserver: ResizeObserver\r\n  private outline: HTMLElement | null = null;\r\n  private nodeChangeUnsubscribe: Unsubscribe;\r\n  private currentId: ID | null = null\r\n  private unActive: Unsubscribe\r\n  private unCanvasScroll: Unsubscribe\r\n\r\n  constructor(protected engine: IDesignerEngine) {\r\n    if (!engine.getShell().getContainer) {\r\n      console.error(\"Html 5 driver rootElement is undefined\")\r\n    }\r\n    this.resizeObserver = new ResizeObserver(this.onResize)\r\n    this.nodeChangeUnsubscribe = engine.getMonitor().subscribeToHasNodeChanged(this.refresh)\r\n    this.unActive = engine.getMonitor().subscribeToActiveChanged(this.handleActivedChange)\r\n    this.unCanvasScroll = this.engine.getShell().subscribeTo(CanvasScrollEvent, this.refresh)\r\n  }\r\n\r\n  onResize = () => {\r\n    this.refresh()\r\n  }\r\n\r\n  handleActivedChange = (activedId: ID | undefined | null): void => {\r\n    this.resizeObserver.disconnect()\r\n    this.clearLine()\r\n    if (activedId) {\r\n      this.currentId = activedId\r\n      this.renderLine(activedId)\r\n    }\r\n  }\r\n  onViewportChange = () => {\r\n    this.refresh()\r\n  }\r\n  refresh = () => {\r\n    if (!this.currentId) {\r\n      return\r\n    }\r\n    this.renderLine(this.currentId)\r\n  }\r\n\r\n  handleOutNode = (e: MouseOutEvent): void => {\r\n    this.clearLine()\r\n    this.currentId = null\r\n  }\r\n\r\n  destory(): void {\r\n    this.clearLine()\r\n    this.nodeChangeUnsubscribe()\r\n    this.unActive()\r\n    this.unCanvasScroll()\r\n  }\r\n\r\n  private renderLine(id: ID) {\r\n    this.clearLine()\r\n    const element = this.engine.getShell().getElement(id)\r\n    const canvas = this.engine.getShell().getCanvas(this.engine.getMonitor().getNodeDocumentId(id) || \"\")\r\n    const containerRect = canvas?.getContainerRect()\r\n    if (element && containerRect) {\r\n      const rect = element.getBoundingClientRect();\r\n      const htmlDiv = document.createElement('div')\r\n      htmlDiv.style.backgroundColor = \"transparent\"\r\n      htmlDiv.style.position = \"fixed\"\r\n      htmlDiv.style.border = `dashed 1px ${AUX_BACKGROUND_COLOR}`\r\n      htmlDiv.style.pointerEvents = \"none\"\r\n      htmlDiv.style.left = numbToPx(rect.left - containerRect.x)\r\n      htmlDiv.style.top = numbToPx(rect.top - containerRect.y)\r\n      htmlDiv.style.height = numbToPx(rect.height - 2)\r\n      htmlDiv.style.width = numbToPx(rect.width - 2)\r\n      htmlDiv.style.zIndex = (getMaxZIndex(element) + 1).toString()\r\n      canvas?.appendChild(htmlDiv)\r\n      this.outline = htmlDiv\r\n      this.resizeObserver.observe(element)\r\n    }\r\n  }\r\n\r\n  private clearLine() {\r\n    if (this.outline) {\r\n      this.outline.remove()\r\n    }\r\n    this.outline = null\r\n  }\r\n}\r\n\r\nexport const ActivedOutline = (engine: IDesignerEngine) => {\r\n  return new ActivedOutlineImpl(engine)\r\n}\r\n"],"names":["CanvasScrollEvent","AUX_BACKGROUND_COLOR","numbToPx","getMaxZIndex","ActivedOutlineImpl","destory","clearLine","nodeChangeUnsubscribe","unActive","unCanvasScroll","renderLine","id","element","engine","getShell","getElement","canvas","getCanvas","getMonitor","getNodeDocumentId","containerRect","getContainerRect","rect","getBoundingClientRect","htmlDiv","document","createElement","style","backgroundColor","position","border","pointerEvents","left","x","top","y","height","width","zIndex","toString","appendChild","outline","resizeObserver","observe","remove","constructor","name","currentId","onResize","refresh","handleActivedChange","activedId","disconnect","onViewportChange","handleOutNode","e","getContainer","console","error","ResizeObserver","subscribeToHasNodeChanged","subscribeToActiveChanged","subscribeTo","ActivedOutline"],"mappings":"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"}