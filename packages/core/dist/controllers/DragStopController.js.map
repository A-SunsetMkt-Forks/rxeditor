{"version":3,"sources":["../../src/controllers/DragStopController.ts"],"sourcesContent":["import { IDesignerEngine, NodeRelativePosition } from \"core\";\r\nimport { DragStopEvent } from \"shell/events\";\r\nimport { HistoryableActionType, IDocument, Unsubscribe } from \"interfaces\";\r\nimport { AcceptType, DrageOverOptions } from \"interfaces/action\";\r\nimport { IPlugin } from \"interfaces/plugin\";\r\nimport { DraggingNodesState } from \"reducers/draggingNodes\";\r\nimport { DraggingResourceState } from \"reducers/draggingResource\";\r\nimport { RelativePosition } from \"utils/coordinate\";\r\nimport { invariant } from \"utils/util-invariant\";\r\n\r\nexport class DragStopControllerImpl implements IPlugin {\r\n  name: string = \"default.drag-stop-controller\";\r\n\r\n  unsucribe: Unsubscribe\r\n  constructor(protected engine: IDesignerEngine) {\r\n    this.unsucribe = engine.getShell().subscribeTo(DragStopEvent, this.handleDragStop)\r\n  }\r\n\r\n  handleDragStop = (e: DragStopEvent) => {\r\n    this.drop(e)\r\n    if (this.engine.getMonitor().getState().draggingResource) {\r\n      this.engine.getActions().endDragResouce()\r\n    } else if (this.engine.getMonitor().getState().draggingNodes) {\r\n      this.engine.getActions().endDragNodes()\r\n    }\r\n    this.engine.getActions().dragover(null)\r\n  }\r\n\r\n  drop(e: DragStopEvent): void {\r\n    const monitor = this.engine.getMonitor()\r\n    const dragOver = monitor.getDrageOver()\r\n    if (dragOver) {\r\n      const document = this.engine.getNodeDocument(dragOver.targetId)\r\n      invariant(document, \"can not find node document by id:\" + dragOver.targetId)\r\n      if (!document?.id) {\r\n        return\r\n      }\r\n      const draggingResource = monitor.getState().draggingResource\r\n      if (draggingResource) {\r\n        this.dropResource(draggingResource, dragOver, document);\r\n      } else {\r\n        const draggingNodes = monitor.getState().draggingNodes\r\n        if (draggingNodes) {\r\n          this.dropNodes(draggingNodes, dragOver, document);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private dropResource = (draggingResource: DraggingResourceState, dragOver: DrageOverOptions, document: IDocument) => {\r\n    const resource = this.engine.getResourceManager().getResource(draggingResource?.resource || \"\");\r\n    const pos = this.tranPosition(dragOver.position)\r\n    if (resource && pos && dragOver.type === AcceptType.Accept) {\r\n      const nodes = document.addNewNodes(resource.elements, dragOver.targetId, pos);\r\n      document.backup(HistoryableActionType.Add)\r\n      this.engine.getActions().selectNodes(nodes.rootNodes.map(node => node.id), document.id);\r\n    }\r\n  }\r\n\r\n  private dropNodes(draggingNodes: DraggingNodesState, dragOver: DrageOverOptions, document: IDocument) {\r\n    if (!draggingNodes) {\r\n      return\r\n    }\r\n    for (const nodeId of draggingNodes.nodeIds || []) {\r\n      const nodDocument = this.engine.getNodeDocument(dragOver.targetId)\r\n      const pos = this.tranPosition(dragOver.position)\r\n      if (nodDocument?.id === document.id && pos && dragOver.type === AcceptType.Accept) {\r\n        document.moveTo(nodeId, dragOver.targetId, pos)\r\n        document.backup(HistoryableActionType.Move)\r\n      } else {\r\n        //预留实现\r\n        //nodDocument?.getActions().remove(nodeId)\r\n        //document.getActions().addNodeFormOutside()\r\n      }\r\n    }\r\n    this.engine.getActions().selectNodes(draggingNodes.nodeIds, document.id);\r\n\r\n  }\r\n\r\n  private tranPosition(curPos: RelativePosition | null): NodeRelativePosition | null {\r\n    switch (curPos) {\r\n      case RelativePosition.In:\r\n        return NodeRelativePosition.InBottom\r\n      case RelativePosition.Left:\r\n      case RelativePosition.Top:\r\n        return NodeRelativePosition.Before\r\n      case RelativePosition.Right:\r\n      case RelativePosition.Bottom:\r\n        return NodeRelativePosition.After\r\n    }\r\n    return null\r\n  }\r\n\r\n  destory(): void {\r\n    this.unsucribe()\r\n  }\r\n}\r\n\r\nexport const DragStopController = (engine: IDesignerEngine) => {\r\n  return new DragStopControllerImpl(engine)\r\n}"],"names":["NodeRelativePosition","DragStopEvent","HistoryableActionType","AcceptType","RelativePosition","invariant","DragStopControllerImpl","drop","e","monitor","engine","getMonitor","dragOver","getDrageOver","document","getNodeDocument","targetId","id","draggingResource","getState","dropResource","draggingNodes","dropNodes","nodeId","nodeIds","nodDocument","pos","tranPosition","position","type","Accept","moveTo","backup","Move","getActions","selectNodes","curPos","In","InBottom","Left","Top","Before","Right","Bottom","After","destory","unsucribe","constructor","name","handleDragStop","endDragResouce","endDragNodes","dragover","resource","getResourceManager","getResource","nodes","addNewNodes","elements","Add","rootNodes","map","node","getShell","subscribeTo","DragStopController"],"mappings":"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"}